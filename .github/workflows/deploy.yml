name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      clear_db:
        description: 'ğŸ§ª DB ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸ (ê¸°ì¡´ ë°ì´í„° ì‚­ì œ)'
        required: false
        type: choice
        options:
          - 'false'
          - 'true'
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          # SSH í‚¤ ì„¤ì •
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          # SSH ì ‘ì† ë° ë°°í¬
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${USER}@${HOST} bash -s << 'ENDSSH'
            set -e
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (ì—†ìœ¼ë©´ ìƒì„±)
            mkdir -p ~/moviestar
            cd ~/moviestar
            
            # Git ì €ì¥ì†Œ ì´ˆê¸°í™” (ìµœì´ˆ ì‹¤í–‰ ì‹œ)
            if [ ! -d .git ]; then
              git clone https://github.com/${{ github.repository }} .
            fi
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git fetch origin
            git reset --hard origin/main
            
            # ì„œë²„ ì´ˆê¸° ì„¤ì • (Docker ì—†ì„ ê²½ìš° ìë™ ì„¤ì¹˜)
            if ! command -v docker &> /dev/null; then
              echo "ğŸ”§ ì„œë²„ ì´ˆê¸° ì„¤ì • ì‹¤í–‰..."
              chmod +x setup-server.sh
              ./setup-server.sh
            fi
            
            # Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            sudo docker-compose down || true
            
            # ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹œì‘ (ì•±ì´ ìë™ìœ¼ë¡œ DB ì´ˆê¸°í™”)
            sudo docker-compose up -d --build
            
            # í•™ìŠµìš©: ë§¤ë²ˆ DB ë°ì´í„° ì‚­ì œí•˜ì—¬ ìë™ ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸
            echo "ğŸ§ª í•™ìŠµìš© - DB ë°ì´í„° ì‚­ì œ ì¤‘..."
            sleep 5  # ì»¨í…Œì´ë„ˆê°€ ì™„ì „íˆ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            sudo docker-compose exec -T mongodb mongosh dbjungle --quiet --eval "db.movies.deleteMany({})" > /dev/null 2>&1 || true
            echo "âœ… DB ë°ì´í„° ì‚­ì œ ì™„ë£Œ"
            
            # init_db.py ì§ì ‘ ì‹¤í–‰í•˜ì—¬ DB ì´ˆê¸°í™”
            echo "ğŸ”„ DB ì´ˆê¸°í™” ì‹¤í–‰ ì¤‘..."
            sudo docker-compose exec -T app python init_db.py || true
            echo "âœ… DB ì´ˆê¸°í™” ì™„ë£Œ"
            
            # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
            echo "â³ ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
            sleep 15
            
            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
            echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            sudo docker-compose ps
            
            echo "ğŸ“ ì•± ì‹œì‘ ë¡œê·¸ (DB ìë™ ì´ˆê¸°í™” í™•ì¸):"
            sudo docker-compose logs --tail=40 app
          ENDSSH
          
          # SSH í‚¤ ì‚­ì œ
          rm -f private_key.pem

      - name: Verify Deployment
        env:
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "ğŸ” ë°°í¬ ê²€ì¦ ì¤‘..."
          sleep 3
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${HOST}:5000 || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… ë°°í¬ ì„±ê³µ! ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤."
            echo "ğŸŒ URL: http://${HOST}:5000"
          else
            echo "âš ï¸ ë°°í¬ í™•ì¸ í•„ìš” (HTTP Code: $HTTP_CODE)"
            exit 1
          fi
