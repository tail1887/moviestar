name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 수동 실행 가능
    inputs:
      clear_db:
        description: '🧪 DB 초기화 테스트 (기존 데이터 삭제)'
        required: false
        type: choice
        options:
          - 'false'
          - 'true'
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-to-ec2
      cancel-in-progress: false  # 이전 배포가 끝날 때까지 대기
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          # SSH 키 설정
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          # SSH 접속 및 배포
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${USER}@${HOST} bash -s << 'ENDSSH'
            # set -e 제거: 일부 명령 실패 시에도 계속 진행
            set -x  # 디버깅을 위한 명령어 출력 활성화
            
            # 프로젝트 디렉토리로 이동 (없으면 생성)
            mkdir -p ~/moviestar
            cd ~/moviestar
            
            # Git 저장소 초기화 (최초 실행 시)
            if [ ! -d .git ]; then
              git clone https://github.com/${{ github.repository }} .
            fi
            
            # 최신 코드 가져오기
            git fetch origin
            git reset --hard origin/main
            
            # 서버 초기 설정 (Docker 없을 경우 자동 설치)
            if ! command -v docker &> /dev/null; then
              echo "🔧 서버 초기 설정 실행..."
              chmod +x setup-server.sh
              ./setup-server.sh
            fi
            
            # Docker 컨테이너 중지 및 삭제
            sudo docker-compose down || true
            
            # 새 이미지 빌드 및 컨테이너 시작
            sudo docker-compose up -d --build
            
            # 컨테이너가 완전히 시작될 때까지 대기
            echo "⏳ 컨테이너 시작 대기 중..."
            sleep 10
            
            # 학습용: 매번 DB 데이터 삭제하여 자동 초기화 테스트
            echo "🧪 학습용 - DB 데이터 삭제 중..."
            DELETE_RESULT=$(sudo docker-compose exec -T mongodb mongosh dbjungle --quiet --eval "db.movies.deleteMany({})" 2>&1) || {
              echo "⚠️ 삭제 실패 (컨테이너 준비 중)"
              DELETE_RESULT=""
            }
            echo "삭제 결과: ${DELETE_RESULT}"
            
            # 앱 재시작하여 자동 초기화 트리거
            echo "🔄 앱 재시작 (자동 초기화 트리거)..."
            sudo docker-compose restart app || echo "⚠️ 앱 재시작 실패, 계속 진행..."
            
            # 초기화 완료 대기 (스크래핑은 시간이 걸릴 수 있음)
            echo "⏳ DB 초기화 대기 중 (스크래핑 시간 포함)..."
            sleep 30
            
            # 초기화 완료 확인 (최대 60초 대기)
            echo "🔍 DB 초기화 완료 확인 중..."
            MAX_WAIT=60
            WAIT_COUNT=0
            MOVIE_COUNT="0"
            while [ $WAIT_COUNT -lt $MAX_WAIT ]; do
              COUNT_RESULT=$(sudo docker-compose exec -T mongodb mongosh dbjungle --quiet --eval "db.movies.countDocuments({})" 2>&1 || echo "0")
              MOVIE_COUNT=$(echo "$COUNT_RESULT" | tr -d '\r\n' | grep -oE '[0-9]+' || echo "0")
              if [ "$MOVIE_COUNT" != "0" ] && [ -n "$MOVIE_COUNT" ] && [ "$MOVIE_COUNT" != "" ]; then
                echo "✅ DB 초기화 완료! 영화 데이터: ${MOVIE_COUNT}개"
                break
              fi
              echo "⏳ 대기 중... (${WAIT_COUNT}초/${MAX_WAIT}초) - 현재 영화 수: ${MOVIE_COUNT}"
              sleep 5
              WAIT_COUNT=$((WAIT_COUNT + 5))
            done
            
            if [ "$MOVIE_COUNT" = "0" ] || [ -z "$MOVIE_COUNT" ] || [ "$MOVIE_COUNT" = "" ]; then
              echo "⚠️ 경고: DB 초기화가 완료되지 않았습니다. 로그를 확인하세요."
            fi
            
            echo "🎉 배포 완료!"
            echo "📊 컨테이너 상태:"
            sudo docker-compose ps || echo "⚠️ 컨테이너 상태 확인 실패"
            
            echo "📝 앱 시작 로그 (DB 자동 초기화 확인):"
            sudo docker-compose logs --tail=50 app || echo "⚠️ 로그 확인 실패"
            
            echo "✅ 스크립트 실행 완료"
          ENDSSH
          
          # SSH 키 삭제
          rm -f private_key.pem

      - name: Verify Deployment
        env:
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "🔍 배포 검증 중..."
          sleep 3
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${HOST}:5000 || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ 배포 성공! 애플리케이션이 정상 작동 중입니다."
            echo "🌐 URL: http://${HOST}:5000"
          else
            echo "⚠️ 배포 확인 필요 (HTTP Code: $HTTP_CODE)"
            exit 1
          fi
