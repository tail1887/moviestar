name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          # SSH í‚¤ ì„¤ì •
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          # SSH ì ‘ì† ë° ë°°í¬
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${USER}@${HOST} << 'ENDSSH'
            set -e
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (ì—†ìœ¼ë©´ ìƒì„±)
            mkdir -p ~/moviestar
            cd ~/moviestar
            
            # Git ì €ì¥ì†Œ ì´ˆê¸°í™” (ìµœì´ˆ ì‹¤í–‰ ì‹œ)
            if [ ! -d .git ]; then
              git clone https://github.com/${{ github.repository }} .
            fi
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git fetch origin
            git reset --hard origin/main
            
            # ì„œë²„ ì´ˆê¸° ì„¤ì • (Docker ì—†ì„ ê²½ìš° ìë™ ì„¤ì¹˜)
            if ! command -v docker &> /dev/null; then
              echo "ğŸ”§ ì„œë²„ ì´ˆê¸° ì„¤ì • ì‹¤í–‰..."
              chmod +x setup-server.sh
              ./setup-server.sh
            fi
            
            # Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            sudo docker-compose down || true
            
            # ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹œì‘
            sudo docker-compose up -d --build
            
            # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
            sleep 5
            
            # DB ì´ˆê¸°í™” ì—¬ë¶€ í™•ì¸ (movies ì»¬ë ‰ì…˜ì´ ë¹„ì–´ìˆìœ¼ë©´ ì´ˆê¸°í™”)
            DB_COUNT=$(sudo docker-compose exec -T mongodb mongosh --quiet --eval "db.getSiblingDB('dbjungle').movies.countDocuments()" || echo "0")
            if [ "$DB_COUNT" = "0" ]; then
              echo "ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘..."
              sudo docker-compose exec -T app python init_db.py
            else
              echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì–´ ìˆìŒ (ì˜í™” ìˆ˜: $DB_COUNT)"
            fi
            
            # ë°°í¬ ì™„ë£Œ í™•ì¸
            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
            sudo docker-compose ps
          ENDSSH
          
          # SSH í‚¤ ì‚­ì œ
          rm -f private_key.pem

      - name: Verify Deployment
        env:
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "ğŸ” ë°°í¬ ê²€ì¦ ì¤‘..."
          sleep 3
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${HOST}:5000 || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… ë°°í¬ ì„±ê³µ! ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤."
            echo "ğŸŒ URL: http://${HOST}:5000"
          else
            echo "âš ï¸ ë°°í¬ í™•ì¸ í•„ìš” (HTTP Code: $HTTP_CODE)"
            exit 1
          fi
